---
title: "Visual perception and effective plot construction"
subtitle: "SISBID 2019 <br> https://github.com/dicook/SISBID"
author: "Di Cook (dicook@monash.edu, @visnut) <br> Heike Hofmann (heike.hofmann@gmail.com, @heike_hh)"
date: "07/24-26/2019"
output:
  xaringan::moon_reader:
    css: ["default", "myremark.css"]
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE, 
  collapse = TRUE,
  comment = "",
  fig.height = 6,
  fig.width = 10,
  fig.align = "center",
  fig.retina = 3,
  cache = FALSE
)
```

```{r echo=FALSE}
library(tidyverse)
library(ggmap)
library(HLMdiag)
library(RColorBrewer)
library(gridExtra)
library(dichromat)
library(janitor)
library(forcats)
library(ggthemes)
library(here)
```


```{r read TB data and wrangle and subset to USA}
tb <- read_csv(here::here("data/TB_notifications_2019-07-01.csv")) %>% 
  select(country, iso3, year, new_sp_m04:new_sp_fu) %>%
  gather(stuff, count, new_sp_m04:new_sp_fu) %>%
  separate(stuff, c("stuff1", "stuff2", "sexage")) %>%
  select(-stuff1, -stuff2) %>%
  mutate(sex=substr(sexage, 1, 1), 
         age=substr(sexage, 2, length(sexage))) %>%
  select(-sexage)

# Filter years between 1997 and 2012 due to missings
tb_us <- tb %>% 
  filter(country == "United States of America") %>%
  filter(!(age %in% c("04", "014", "514", "u"))) %>%
  filter(year > 1996, year < 2013)
```


---
# Proximity

```{r focus on one year gender, side-by-side bars of males/females, echo=TRUE, fig.height=3}
tb_us %>% filter(year == 2012) %>%
  ggplot(aes(x=sex, y=count, fill=sex)) +
  geom_bar(stat="identity", position="dodge") + 
  facet_wrap(~age, ncol=6) +
  scale_fill_brewer("", palette="Dark2") +
  ggtitle("Arrangement A")
```

```{r focus on one year age, side-by-side bars of age group, echo=TRUE, fig.height=3}
tb_us %>% filter(year == 2012) %>%
  ggplot(aes(x=age, y=count, fill=age)) +
  geom_bar(stat="identity", position="dodge") + 
  facet_wrap(~sex, ncol=6) +
  scale_fill_brewer("", palette="Dark2") +
  ggtitle("Arrangement B")
```

`r set.seed(20190709); emo::ji("fantasy")` `r set.seed(20190712); emo::ji("fantasy")` `r set.seed(20190711); emo::ji("fantasy")` **TWO MINUTE CHALLENGE**

We've got two different rearrangements of the same information. 

What do we learn? That is different from each? What's the focus of each? What's easy, what's harder?

```{r eval=FALSE}
- Arrangement A makes it easier to directly compare male and female counts, separately for each age group. Generally, male counts are higher than female counts. There is a big difference between counts in the 45-54 age group, and over 65 counts are almost the same.
- Arrangement B makes it easier to directly compare counts by age group, separately for females and males. For females, incidence drops in the middle years. For males, it is pretty consistently high across age groups. 
```



---
# Line plot vs barchart

```{r use a line plot instead of bar, fig.height=3}
ggplot(tb_us, aes(x=year, y=count, colour=sex)) +
  geom_line() + geom_point() +
  facet_wrap(~age, ncol=6) +
  scale_colour_brewer("", palette="Dark2") 
```

```{r colour and axes fixes, echo=TRUE, fig.height=3}
# This uses a color blind proof scale
ggplot(tb_us, aes(x=year, y=count, fill=sex)) +
  geom_bar(stat="identity") + 
  facet_wrap(~age, ncol=6) +
  scale_fill_brewer("", palette="Dark2") 
```

`r set.seed(20190709); emo::ji("fantasy")` `r set.seed(20190712); emo::ji("fantasy")` `r set.seed(20190711); emo::ji("fantasy")` **TWO MINUTE CHALLENGE**

- What are the pros and cons of each way of displaying the same information?

---
# Line plot vs barchart

```{r use a line plot for proportions, fig.height=3}
tb_us %>% group_by(year, age) %>% 
  summarise(p = count[sex=="m"]/sum(count)) %>%
  ggplot(aes(x=year, y=p)) +
  geom_line() + geom_point() +
  facet_wrap(~age, ncol=6) +
  ylab("proportion of males")
```

```{r compare proportions of males/females, echo=TRUE, fig.height=3}
# Fill the bars, note the small change to the code
ggplot(tb_us, aes(x=year, y=count, fill=sex)) +
  geom_bar(stat="identity", position="fill") + 
  facet_wrap(~age, ncol=6) +
  scale_fill_brewer("", palette="Dark2") + ylab("proportion")
```

`r set.seed(20190709); emo::ji("fantasy")` `r set.seed(20190712); emo::ji("fantasy")` `r set.seed(20190711); emo::ji("fantasy")` **TWO MINUTE CHALLENGE**

- What are the pros and cons of each way of displaying the same information?

---
# Perceptual principles

- Hierarchy of mappings: (first) position along an axis - (last) color (Cleveland, 1984; Heer and Bostock, 2009)
- Pre-attentive: Some elements are noticed before you even realise it.
- Color: (pre-attentive) palettes - qualitative, sequential, diverging.
- Proximity: Place elements for primary comparison close together. 
- Change blindness: When focus is interrupted differences may not be noticed.

---
# Color palettes - default

```{r echo=TRUE, fig.height=4, eval=FALSE}
p <- ggplot(fly_sub, aes(x=in_general_is_itrude_to_bring_a_baby_on_a_plane,
                    fill=gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5)
p
```

What do we learn?

---
# Color palettes - brewer

```{r echo=TRUE, fig.height=4, eval=FALSE}
p + scale_fill_brewer(palette="Dark2") 
```

[Color Brewer web site](http://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3) annotates the palettes indicating attributes of the palettes.

---
# Color blind-proofing

```{r  echo=TRUE, fig.show='hide', eval=FALSE}
library(scales)
library(dichromat)
clrs <- hue_pal()(3)
p + theme(legend.position = "none")
clrs <- dichromat(hue_pal()(3))
p + scale_fill_manual("", values=clrs) + theme(legend.position = "none")
```

The packages `colorblind` has color blind friendly palettes but the colours are awful, to my eye.

---

```{r echo=FALSE, fig.width=5, fig.show='hold', fig.align='default', eval=FALSE}
clrs <- hue_pal()(3)
p + theme(legend.position = "none")
clrs <- dichromat(hue_pal()(3))
p + scale_fill_manual("", values=clrs) + theme(legend.position = "none")
```


---
# Hierarchy of mappings

- 1.Position - common scale (BEST)
- 2.Position - nonaligned scale
- 3.Length, direction, angle
- 4.Area
- 5.Volume, curvature
- 6.Shading, color (WORST)

---
# Pre-attentive

Can you find the odd one out?

```{r echo=FALSE}
df <- data.frame(x=runif(100), y=runif(100), cl=sample(c(rep("A", 1), rep("B", 99))))
ggplot(data=df, aes(x, y, shape=cl)) + theme_bw() + 
  geom_point(size=3) +
  theme(legend.position="None", aspect.ratio=1)
```

---

Is it easier now?

```{r echo=FALSE}
ggplot(data=df, aes(x, y, colour=cl)) + 
  geom_point(size=3) +
  theme_bw() + 
  scale_colour_brewer(palette="Dark2") +
  theme(legend.position="None", aspect.ratio=1)
```


---
# Color palettes

- Qualitative: categorical variables
- Sequential: low to high numeric values
- Diverging: negative to positive values

---

```{r, echo=FALSE, fig.height=7, fig.width=12}
library(RColorBrewer)
display.brewer.all()
```


---
# Proximity

```{r fig.show='hide', eval=FALSE}
ggplot(fly_sub, aes(x=in_general_is_itrude_to_bring_a_baby_on_a_plane,
                    fill=gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5)
```

With this arrangement we can see proportion of gender within each rudeness category, and compare these across age groups.  How could we arrange this differently?

---


```{r echo=FALSE, eval=FALSE}
ggplot(fly_sub, aes(x=in_general_is_itrude_to_bring_a_baby_on_a_plane,
                    fill=gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5)
```


---
# Proximity

```{r fig.show='hide', echo=TRUE, eval=FALSE}
ggplot(fly_sub, aes(x=gender,
   fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5) +
  theme(legend.position="bottom")
```

---

```{r echo=FALSE, eval=FALSE}
ggplot(fly_sub, aes(x=gender,
                    fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5) + theme(legend.position="bottom")
```

What is different about the comparison now?

---
# Another arrangement

```{r fig.show='hide', echo=TRUE, eval=FALSE}
ggplot(fly_sub, aes(x=age,
                    fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~gender, ncol=5) + 
  theme(legend.position="bottom")
```

---

```{r echo=FALSE, eval=FALSE}
ggplot(fly_sub, aes(x=age,
                    fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~gender, ncol=5) + theme(legend.position="bottom")
```

---
# My principles

- Make a plot is the most important message. For most purposes the hierarchy doesn't much matter. 
- Knowing how to use proximity is an extremely valuable skill, and not well utilised.
- Use of colour is also a very valuable skill, and there are many bad habits to over-use, too many colours or precariously map to a continuous variable to add another dimension. 
-
- Plot the data! There are a lot of examples where the statistics are plotted, but the magic comes when you plot the data. Plot the statistics if the volume of data is overwhelming, to tighten the message, but still plot the data for yourself.

---
# Themes

The `ggthemes` package has many different styles for the plots. Other packages such as `xkcd`, `skittles`, `wes anderson`, `beyonce`, ....

```{r fig.show='hide', echo=TRUE, eval=FALSE}
ggplot(fly_sub, aes(x=gender,
                    fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5) +
  theme_tufte() + theme(legend.position="bottom")
```

See the [vignette](https://cran.r-project.org/web/packages/xkcd/vignettes/xkcd-intro.pdf) for instructions on installing the xkcd font. 

---

```{r, eval=FALSE}
library(xkcd)
ggplot(fly_sub, aes(x=gender,
                    fill=in_general_is_itrude_to_bring_a_baby_on_a_plane)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~age, ncol=5) +
  theme_xkcd() + theme(legend.position="bottom")
```

---
# Resources

- [RStudio cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
- [ggplot2: Elegant Graphics for Data Analysis, Hadley Wickham](http://ggplot2.org/book/), [web site](http://ggplot2.org)
- [R Graphics Cookbook, Winston Chang](http://www.cookbook-r.com/Graphs/)
- [Naomi Robbins, Creating More Effective Graphs](http://www.nbr-graphs.com)
- [Antony Unwin, Graphical Data Analysis with R](https://www.crcpress.com/Graphical-Data-Analysis-with-R/Unwin/9781498715232)

---
# Share and share alike

This work is licensed under the Creative Commons Attribution-Noncommercial 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc/3.0/us/ or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
