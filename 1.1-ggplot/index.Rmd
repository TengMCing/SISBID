---
title: "Grammar of Graphics and ggplot2"
subtitle: "SISBID 2018 <br> https://github.com/dicook/SISBID"
author: "Di Cook (dicook@monash.edu, @visnut) <br> Heike Hofmann (heike.hofmann@gmail.com, @heike_hh)"
date: "07/25-27/2018"
output:
  xaringan::moon_reader:
    css: ["default", "myremark.css"]
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE, 
  collapse = TRUE,
  comment = "",
  fig.height = 6,
  fig.width = 10,
  fig.align = "center",
  cache = FALSE
)
```

```{r echo=FALSE}
library(tidyverse)
library(ggmap)
library(HLMdiag)
library(RColorBrewer)
library(gridExtra)
library(dichromat)
library(xkcd)
```


class: inverse middle 
# Your turn: What is a data plot?

Write down as many types of data plots that you can. You've got 30 seconds.

---

```{r fig.width=10, fig.height=8}
library(wordcloud)
namedplots <- c("histogram", "barchart", "scatterplot", "piechart", "lineplot", "densityplot", "boxplot", "dendrogram", "treemap", "scatterplotmatrix", "parallelcoordinateplot", "biplot", "contourplot", "stemandleafplot", "rugplot", "dotplot", "mosaicplot", "spineplot", "forestplot", "heatmap", "qqplot", "starplot", "chernoffface","graph", "beeswarm", "violinplot")
pal <- brewer.pal(8,"Dark2")
wordcloud(namedplots, freq = sample(1:8, length(namedplots), replace=TRUE), colors=pal)
```

---
# What is a data plot?

- data
- **aesthetics: mapping of variables to graphical elements**
- geom: type of plot structure to use
- transformations: log scale, ...
- layers: multiple geoms, multiple data sets, annotation
- facets: show subsets in different plots
- themes: modifying style

---
# Why?

With the grammar, a data plot becomes a statistic. It is a functional mapping from variable to graphical element. Then we can do statistics on data plots. 

With a grammar, we don't have individual animals in the zoo, we have the genetic code that says how one plot is related to another plot.

---
# Elements of the grammar

```
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(
     mapping = aes(<MAPPINGS>),
     stat = <STAT>, 
     position = <POSITION>
  ) +
  <COORDINATE_FUNCTION> +
  <FACET_FUNCTION>
```

The 7 key elements of the grammar are:

- DATA
- GEOM_FUNCTION
- MAPPINGS
- STAT
- POSITION
- COORDINATE_FUNCTION
- FACET_FUNCTION

---
# Example: Tuberculosis data

This is current tuberculosis data taken from [WHO](http://www.who.int/tb/country/data/download/en/), the case notifications table.

```{r}
tb <- read_csv("../data/TB_notifications_2018-03-18.csv") %>% 
  select(country, iso3, year, new_sp_m04:new_sp_fu) %>%
  gather(stuff, count, new_sp_m04:new_sp_fu) %>%
  separate(stuff, c("stuff1", "stuff2", "genderage")) %>%
  select(-stuff1, -stuff2) %>%
  mutate(gender=substr(genderage, 1, 1), 
         age=substr(genderage, 2, length(genderage))) %>%
  select(-genderage)

tb_us <- tb %>% 
  filter(country == "United States of America") %>%
  filter(!(age %in% c("04", "014", "514", "u"))) %>%
  filter(year > 1996, year < 2013)
```

```{r echo=TRUE, fig.width=10, fig.height=3}
ggplot(tb_us, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~ age) +
  scale_fill_brewer(palette="Dark2")
```

---

100% charts, is what excel names these beasts. What do we learn?

- Focus is on **proportion** in each category. 
- Across all ages, and years, the proportion of males having TB is higher than females
- These proportions tend to be higher in the middle age groups, for all years.
- Relatively similar proportions across years.

---
# Bar charts

```{r echo=TRUE, fig.width=10, fig.height=3}
ggplot(tb_us, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity") +
  facet_grid(~ age) +
  scale_fill_brewer(palette="Dark2")
```

---

What do we learn?

- Focus is on **counts** in each category. 
- Different across ages, and years, counts tend to be lower in young age (15-24)
- Incidence has been decreasing although among younger age groups it is only in recent years.


---
# Side-by-side barcharts

```{r echo=TRUE, fig.width=10, fig.height=3}
ggplot(tb_us, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity", position="dodge") +
  facet_grid(~ age) +
  scale_fill_brewer(palette="Dark2")
```

---

What do we learn?

- Focus is on counts by gender, predominantly male incidence.
- There is similar incidence between males and females in younger age groups.
- Decline is less prominent among middle age females.

---
#  Separate bar charts

```{r echo=TRUE, fig.width=10, fig.height=4}
ggplot(tb_us, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity") +
  facet_grid(gender ~ age) +
  scale_fill_brewer(palette="Dark2")
```

---

What do we learn?

- Its easier to focus separately on males and females.

---
# Pie charts?

```{r echo=TRUE, fig.width=10, fig.height=4}
ggplot(tb_us, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity") +
  facet_grid(gender ~ age) +
  scale_fill_brewer(palette="Dark2") + 
  coord_polar() +
  theme(axis.text = element_blank())
```

---

Nope! That's a rose chart. Bar charts in polar coordinates produce rose charts. 

What do we learn?

- Emphasizes the difference between men and women, and really small numbers for middle aged females. 

---
# Rainbow charts?

```{r echo=TRUE, fig.width=10, fig.height=4}
ggplot(tb_us, aes(x = 1, y = count, fill = factor(year))) +
  geom_bar(stat = "identity", position="fill") +
  facet_grid(gender ~ age) 
```

---

A single stacked bar, in each facet. Year is mapped to colour. 

What do we learn?

- Pretty chart but not easy to interpret. 

---
# Pie charts

```{r echo=TRUE, fig.width=10, fig.height=4}
ggplot(tb_us, aes(x = 1, y = count, fill = factor(year))) +
  geom_bar(stat = "identity", position="fill") +
  facet_grid(gender ~ age) +
  coord_polar(theta="y") +
  theme(axis.text = element_blank())
```

---

What do we learn?

- Pretty chart but not easy to interpret, or make comparisons across age groups. 

---
class: inverse middle 
# Your turn

- Choose a different country to examine relative to tuberculosis incidence, for example, Australia. 
- Make an R Markdown notebook for your analysis
- Create the same sequence of plots as done in slides 7-20 for your chosen country's data
- Write a paragraph describing what you have learned about tb in your chosen country from each plot. 


---
# Example 2: Platypus in Australia

Where can you find the strange platypus in Australia?

![](Platypus-sketch.jpg)

---

```{r eval=FALSE}
# Data extracted from ALA with this code
# install.packages("ALA4R")
library(ALA4R)
l <- specieslist("platypus")
platypus <- occurrences("Ornithorhynchus anatinus", download_reason_id=10)
save(platypus, file="data/platypus.rda")
```

```{r echo=TRUE}
load("../data/platypus.rda")
platydata <- platypus$data
ggplot(data=platydata) + geom_point(aes(x=longitude, y=latitude))
```



---

Add some transparency to see density of locations.

```{r echo=TRUE}
ggplot(data=platydata) + geom_point(aes(x=longitude, y=latitude), alpha=0.1)
```

---

If you are good at recognising the shape of Australia, you might realise that the sightings are all along the east coast and Tasmania. There is a strange location, that looks like someone saw one in Antarctica! We might need to filter this observation out later, because its extremely unlikely to have been found that far south.

But, we can make it look a bit more like Australia by making a map projection, using `coord_map`.

---


```{r  echo=TRUE, fig.height=6}
ggplot(data=platydata) + 
  geom_point(aes(x=longitude, y=latitude), alpha=0.1) +
  coord_map()
```


The locations would be even more recognisable if we added a real map underneath. One way this can be done is to use a google map. The `ggmap` package has an interface to extracting google maps. Install it and then grab a map of Australia with this code.

---

```{r echo=TRUE}
library(ggmap)
oz <- get_map(location=c(lon=133.8807, lat=-23.6980), zoom=4)
ggmap(oz) + 
  geom_point(data=platydata, aes(x=longitude, y=latitude), 
              alpha=0.1, colour="orange")
```

---
class: inverse middle 
# Your turn

Change the dotplot into a density plot, to focus on the locations of frequent sightings.

Do you learn anything different than from the scatterplot?

---
class: inverse middle 
# Your turn

Platypus are mostly found on the east coast of the country, but there is a population close to Adelaide in south Australia. Why is this?

---
# Temporal trend

The date of the sighting is another variable in the data set. Let's make a plot of the sightings over time. The variable is called `eventDate`. It is considered to be a `character` variable by R, so the first step is to get R to recognise that it is a date time object.

```{r echo=TRUE}
library(lubridate)
platydata <- platydata %>% 
  mutate(eventDate = ymd(eventDate))
```

---

then we can simply plot occurrence over time.

```{r echo=TRUE}
ggplot(data=platydata) +
  geom_point(aes(x=eventDate, y=1))
```

---

There are some records dating back before 1800. There were only records from 1770! And these first records are in the database!

```{r eval=FALSE}
# Check odd cases
platydata %>% filter(latitude < (-50)) 
# These jsut have the lat/long wrong
platydata %>% filter(eventDate < ymd("1850-01-01")) 
```

---

Let's focus on records since 1900, and count the number for each year.

```{r echo=TRUE}
platydata1900 <- platydata %>% filter(year>1900) %>%
  count(year) 
ggplot(data=platydata1900) +
  geom_point(aes(x=year, y=n))
```

---

Add a trend line.

```{r echo=TRUE}
ggplot(data=platydata1900, aes(x=year, y=n)) +
  geom_point() +
  geom_smooth(se=F)
```

---
Make it interactive so that we can investigate some observations.

```{r echo=TRUE}
library(plotly)
ggplotly()
```

---
class: inverse middle 
# Your turn

*Discussion question:* Was there a population explosion in 1980 and 2004? Is the population of platypus increasing since 1900, and decreasing in the last decade?

---
class: inverse middle 
# Your turn

- Subset the data to 1960-2010
- Create a new variable for decade
- Make a map separately for each decade - the `facet_wrap` function can help here.

---
# Example 3: Flying etiquette

[41% Of Fliers Think You’re Rude If You Recline Your Seat](http://fivethirtyeight.com/datalab/airplane-etiquette-recline-seat/)

```{r echo=FALSE}
fly <- read_csv("../data/flying-etiquette.csv")
glimpse(fly)
```

---
# Variables

- Mix of categorical and quantitative variables. 
- What mappings are appropriate? 
- Area for counts of categories, 
- side-by-side boxplots for mixed pairs. 

---
# Support

```{r}
ggplot(fly, aes(x=`How often do you travel by plane?`)) + 
  geom_bar() + coord_flip()
```

Categories are not sorted

---
# Sorted categories

```{r}
fly$`How often do you travel by plane?` <- 
  factor(fly$`How often do you travel by plane?`, levels=c(
    "Never","Once a year or less","Once a month or less",
    "A few times per month","A few times per week","Every day"))
ggplot(fly, aes(x=`How often do you travel by plane?`)) + geom_bar() + coord_flip()
ggplot(fly, aes(x=`How often do you travel by plane?`, 
                fill=`How often do you travel by plane?`)) + geom_bar() + coord_flip() +
  scale_fill_brewer(palette="Dark2")
```

---
# Filter data

```{r}
fly_sub <- fly %>% filter(`How often do you travel by plane?` %in% 
                            c("Once a year or less","Once a month or less")) %>%
  filter(!is.na(`Do you ever recline your seat when you fly?`)) %>%
  filter(!is.na(Age)) %>% filter(!is.na(Gender))
```

---
# Recline by height

```{r}
fly_sub$`Do you ever recline your seat when you fly?` <- factor(
  fly_sub$`Do you ever recline your seat when you fly?`, levels=c(
    "Never","Once in a while","About half the time",
    "Usually","Always"))
ggplot(fly_sub, aes(y=`How tall are you?`, x=`Do you ever recline your seat when you fly?`)) + geom_boxplot() + coord_flip()
```


---
class: inverse middle 
# Your turn

![](lorikeets.png)

- Take a look at the ggplot2 [Cheat sheet](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf)
- How many geoms are available in ggplot2? What is `geom_rug`?

```{r echo=FALSE, eval=FALSE}
A lot of geoms!
  
geom_rug adds tick marks to the axis, particularly for a scatterplot, or density, indicating values of data on that variable. 
```


---
class: inverse middle 
# Your turn

![](lorikeets.png)


What is the difference between `colour` and `fill`?

```{r echo=FALSE, eval=FALSE}
# colour is for 0 or 1-dimensional elements, and fill is for area (2-d) geoms
```

---
class: inverse middle 
# Your turn

![](lorikeets.png)

What does `coord_fixed()` do? What is the difference between this and using `theme(aspect.ratio=...)`?

```{r echo=FALSE, eval=FALSE}
coord_fixed operates on the raw data values, but theme(aspect_ratio=...) works on the plot dimensions
```

---
class: inverse middle 
# Your turn

![](lorikeets.png)

What are scales? How many numeric transformation scales are there?

```{r echo=FALSE, eval=FALSE}
scales do the transformation between data values and graphical element value. most often it is applied to position along x, y which is common, to log or sqrt, .. there are 3 numeric transformations. 
```

---
class: inverse middle 
# Your turn

![](lorikeets.png)

What are position adjustments? When would they be used?

```{r echo=FALSE, eval=FALSE}
positions shift the location some from original coordinates. most often used with bar charts to stack, or put side-by-side
```

---
class: inverse middle 
# Your turn 

![](lorikeets.png)

Use your cheat sheet to work out how to make plot to explore the relationship between 

`Do you ever recline your seat when you fly?` and `Is it rude to recline your seat on a plane?`

```{r echo=FALSE, eval=FALSE}
ggplot(fly_sub, aes(x=`Do you ever recline your seat when you fly?`)) +
  geom_bar() + 
  facet_wrap(~`Is itrude to recline your seat on a plane?`, ncol=3) +
  coord_flip()
ggplot(fly_sub, aes(x=`Do you ever recline your seat when you fly?`,
    fill=`Is itrude to recline your seat on a plane?`)) +
  geom_bar(position="fill") +
  coord_flip()
```



---
# Facets

```{r}
ggplot(fly_sub, 
       aes(x=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar() + coord_flip() + facet_wrap(~Gender)
```

---
# Facets

```{r}
fly_sub$Age <- factor(fly_sub$Age, levels=c("18-29","30-44","45-60","> 60"))
ggplot(fly_sub, aes(x=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar() + coord_flip() + facet_grid(Age~Gender)
```

---
# Color palettes - default

```{r}
p <- ggplot(fly_sub, aes(x=`In general, is itrude to bring a baby on a plane?`,
                    fill=Gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5)
p
```

What do we learn?

---
# Color palettes - brewer

```{r}
p + scale_fill_brewer(palette="Dark2") 
```

---
# Color blind-proofing

```{r fig.show='hide'}
library(scales)
library(dichromat)
clrs <- hue_pal()(3)
p + theme(legend.position = "none")
clrs <- dichromat(hue_pal()(3))
p + scale_fill_manual("", values=clrs) + theme(legend.position = "none")
```

---

```{r echo=FALSE, fig.width=4.5, fig.show='hold', fig.align='default'}
clrs <- hue_pal()(3)
p + theme(legend.position = "none")
clrs <- dichromat(hue_pal()(3))
p + scale_fill_manual("", values=clrs) + theme(legend.position = "none")
```

---
# Perceptual principles

- Hierarchy of mappings: (first) position along an axis - (last) color (Cleveland, 1984; Heer and Bostock, 2009)
- Pre-attentive: Some elements are noticed before you even realise it.
- Color: (pre-attentive) palettes - qualitative, sequential, diverging.
- Proximity: Place elements for primary comparison close together. 
- Change blindness: When focus is interrupted differences may not be noticed.

---
# Hierarchy of mappings

- 1.Position - common scale (BEST)
- 2.Position - nonaligned scale
- 3.Length, direction, angle
- 4.Area
- 5.Volume, curvature
- 6.Shading, color (WORST)

---
# Pre-attentive

Can you find the odd one out?

```{r echo=FALSE}
df <- data.frame(x=runif(100), y=runif(100), cl=sample(c(rep("A", 1), rep("B", 99))))
ggplot(data=df, aes(x, y, shape=cl)) + theme_bw() + 
  geom_point() +
  theme(legend.position="None", aspect.ratio=1)
```

---

Is it easier now?

```{r echo=FALSE}
ggplot(data=df, aes(x, y, colour=cl)) + 
  geom_point() +
  theme_bw() + 
  theme(legend.position="None", aspect.ratio=1)
```


---
# Color palettes

- Qualitative: categorical variables
- Sequential: low to high numeric values
- Diverging: negative to positive values

---

```{r, echo=FALSE, fig.height=7, fig.width=12}
library(RColorBrewer)
display.brewer.all()
```


---
# Proximity

```{r fig.show='hide'}
ggplot(fly_sub, aes(x=`In general, is itrude to bring a baby on a plane?`,
                    fill=Gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5)
```

With this arrangement we can see proportion of gender within each rudeness category, and compare these across age groups.  How could we arrange this differently?

---


```{r echo=FALSE}
ggplot(fly_sub, aes(x=`In general, is itrude to bring a baby on a plane?`,
                    fill=Gender)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5)
```


---
# Proximity

```{r fig.show='hide'}
ggplot(fly_sub, aes(x=Gender,
   fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5) +
  theme(legend.position="bottom")
```

---

```{r echo=FALSE}
ggplot(fly_sub, aes(x=Gender,
                    fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5) + theme(legend.position="bottom")
```

What is different about the comparison now?

---
# Another arrangement

```{r fig.show='hide'}
ggplot(fly_sub, aes(x=Age,
                    fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Gender, ncol=5) + 
  theme(legend.position="bottom")
```

---

```{r echo=FALSE}
ggplot(fly_sub, aes(x=Age,
                    fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Gender, ncol=5) + theme(legend.position="bottom")
```

---
# Themes

The `ggthemes` package has many different styles for the plots. Other packages such as `xkcd`, `skittles`, `wes anderson`, `beyonce`, ....

```{r fig.show='hide'}
library(xkcd)
ggplot(fly_sub, aes(x=Gender,
                    fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5) +
  theme_xkcd() + theme(legend.position="bottom")
```

See the [vignette](https://cran.r-project.org/web/packages/xkcd/vignettes/xkcd-intro.pdf) for instructions on installing the xkcd font. 

---

```{r echo=FALSE}
library(xkcd)
ggplot(fly_sub, aes(x=Gender,
                    fill=`In general, is itrude to bring a baby on a plane?`)) + 
  geom_bar(position="fill") + coord_flip() + facet_wrap(~Age, ncol=5) +
  theme_xkcd() + theme(legend.position="bottom")
```

---
class: inverse middle 
# Your turn

![](lorikeets.png)

Compile the rmarkdown document that you have put together thus far in the workshop!

---
# Resources

- [RStudio cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
- [ggplot2: Elegant Graphics for Data Analysis, Hadley Wickham](http://ggplot2.org/book/), [web site](http://ggplot2.org)
- [R Graphics Cookbook, Winston Chang](http://www.cookbook-r.com/Graphs/)
- [Naomi Robbins, Creating More Effective Graphs](http://www.nbr-graphs.com)
- [Antony Unwin, Graphical Data Analysis with R](https://www.crcpress.com/Graphical-Data-Analysis-with-R/Unwin/9781498715232)

---
# Share and share alike

This work is licensed under the Creative Commons Attribution-Noncommercial 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc/3.0/us/ or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
